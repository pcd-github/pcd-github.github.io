{"ast":null,"code":"var _jsxFileName = \"/Users/paul/OneDrive/Documents/code/src/swrve/src/chart.js\",\n    _s = $RefreshSig$();\n\nimport * as React from \"react\";\nimport { useState } from \"react\";\nimport * as d3 from \"d3\";\nimport SummaryCards from \"./summary.js\";\nimport EndValueChart from './endvaluechart.js';\nimport \"./chartdata.css\";\nimport { histData } from \"./histdata.js\";\nimport { getAvgEquityReturn, getStdDevEquityReturn, getAverageBondReturn, getStdBondReturn } from \"./histdata.js\";\nimport { makePct, getColorStringForRelativeValue, getPerRunClassName, getPortfolioLineClassName, cleanupPrev, findByID } from './common.js';\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\n\nfunction Chart(props) {\n  _s();\n\n  const [allCycleDataState, setAllCycleDataState] = useState([]);\n  const [allCycleMetaState, setAllCycleMetaState] = useState([]);\n  const [avgAdjEndValueState, setAvgAdjEndValueState] = useState(0);\n  const [medianAdjEndValueState, setMedianAdjEndValueState] = useState(0);\n  const [minAdjEndValueState, setMinAdjEndValueState] = useState(0);\n  const [maxAdjEndValueState, setMaxAdjEndValueState] = useState(0);\n  const [avgSpendState, setAvgSpendState] = useState(0);\n  const [medianSpendState, setMedianSpendState] = useState(0);\n  const [minSpendState, setMinSpendState] = useState(0);\n  const [maxSpendState, setMaxSpendState] = useState(0);\n  const [avgReturnsState, setAvgReturnsState] = useState(0);\n  const [medianReturnsState, setMedianReturnsState] = useState(0);\n  const [minReturnsState, setMinReturnsState] = useState(0);\n  const [maxReturnsState, setMaxReturnsState] = useState(0);\n  const [avgAdjApprState, setAvgAdjAppreciationState] = useState(0);\n  const [medianAdjApprState, setMedianAdjAppreciationState] = useState(0);\n  const [minAdjApprState, setMinAdjAppreciationState] = useState(0);\n  const [maxAdjApprState, setMaxAdjAppreciationState] = useState(0);\n  const [numCyclesState, setNumCyclesState] = useState(0);\n  const [numFailsState, setNumFailsState] = useState(0);\n  const [minFailAgeState, setMinFailAgeState] = useState(0);\n  const [medianFailAgeState, setMedianFailAgeState] = useState(0);\n  const svgCycleChartID = 'd3cycletarget';\n  const perRunClass = getPerRunClassName();\n  const hoverLineID = 'hoverLine';\n  const ttWrapID = 'ttwrapper';\n  const ttBackID = 'ttbackground';\n  const ttAgeID = 'ttage';\n  const margin = {\n    top: 40,\n    right: 65,\n    bottom: 40,\n    left: 65\n  };\n  const totalWidth = 960;\n  const totalHeight = 500;\n  const boundedWidth = totalWidth - margin.left - margin.right;\n  const boundedHeight = totalHeight - margin.top - margin.bottom;\n  const tooltipWidth = 75;\n  const tooltipHeight = 75;\n  const marginTranslate = \"translate(\" + margin.left + \",\" + margin.top + \")\";\n  const normalStrokeWidth = 1.5;\n  var allCycleMeta = [];\n\n  const getXScale = () => {\n    var xExt = [props.currentage, props.lifeexpectancy];\n    return d3.scaleLinear().domain(xExt).range([0, boundedWidth]);\n  };\n\n  const getYScale = (rangeMin, rangeMax) => {\n    var yExt = [rangeMin, rangeMax];\n    return d3.scaleLinear().domain(yExt).range([boundedHeight, 0]);\n  };\n\n  const drawAxes = (svg, xScaleIn, yScaleIn, rangeMin, rangeMax) => {\n    svg.append(\"g\").attr(\"class\", perRunClass).attr(\"transform\", \"translate(0,\" + boundedHeight + \")\").call(d3.axisBottom(xScaleIn));\n    svg.append(\"g\").attr(\"class\", perRunClass).call(d3.axisLeft(yScaleIn));\n  };\n\n  const drawPortfolioLine = (svg, xScaleIn, yScaleIn, oneCycleMeta, oneCycle) => {\n    const classNames = perRunClass + ' ' + getPortfolioLineClassName() + ' ' + oneCycleMeta.lineColor;\n    svg.append(\"path\").datum(oneCycle).attr('id', oneCycleMeta.startYear).attr('class', classNames).attr(\"fill\", \"none\").attr(\"pointer-events\", \"none\").style(\"opacity\", 1).attr(\"stroke\", oneCycleMeta.lineColor).attr(\"stroke-width\", normalStrokeWidth).attr(\"d\", d3.line().x(function (d) {\n      return xScaleIn(d.age);\n    }).y(function (d) {\n      return yScaleIn(d.adjEndValue);\n    }));\n  };\n\n  const prepHoverStuff = svg => {\n    const tooltipWrapper = svg.append('g').attr('id', ttWrapID).attr('display', 'none');\n    tooltipWrapper.append('rect').style('opacity', 0.70).attr('id', ttBackID).attr('width', tooltipWidth).attr('height', tooltipHeight).attr(\"pointer-events\", \"none\").attr(\"fill\", \"#e8e8e8\");\n    const tooltipText = tooltipWrapper.append('g').append('text');\n    tooltipText.attr(\"pointer-events\", \"none\").attr('font-weight', 900).attr('text-anchor', 'left');\n    tooltipText.append('tspan').attr('id', ttAgeID).attr('x', '5').attr('y', '5').attr('dy', '15px').attr(\"pointer-events\", \"none\");\n    svg.append(\"g\").append(\"rect\").style('opacity', 0).attr('id', hoverLineID).attr(\"pointer-events\", \"none\").attr(\"class\", \"dotted\").attr(\"stroke-width\", \"1px\").attr(\"width\", \".5px\").attr(\"height\", boundedHeight);\n  };\n\n  const getHoverLine = () => {\n    return findByID(hoverLineID);\n  };\n\n  const getTooltipWrapper = () => {\n    return findByID(ttWrapID);\n  };\n\n  const getTooltipBackground = () => {\n    return findByID(ttBackID);\n  };\n\n  const getTooltipAgeSpan = () => {\n    return findByID(ttAgeID);\n  };\n\n  const getAverageBondReturn = () => {\n    var bondReturns = [];\n\n    for (var i = 0; i < allCycleDataState.length; i++) {\n      bondReturns[i] = allCycleDataState[i].bondReturn;\n    }\n  };\n\n  const handleMouseDown = e => {\n    var avgBondReturn = getAverageBondReturn();\n    var stdBondReturn = getStdBondReturn();\n    console.log('equity avg return:' + makePct(getAvgEquityReturn()) + ' equity sdev:' + makePct(getStdDevEquityReturn()));\n  };\n\n  const handleMouseOver = e => {\n    getHoverLine().style('opacity', 1);\n    getTooltipWrapper().attr('display', null);\n  };\n\n  const handleMouseMove = e => {\n    const bisect = d3.bisector(d => d.age).left;\n    var xScaleIn = getXScale();\n    const coords = d3.pointer(e);\n    const x0 = xScaleIn.invert(coords[0]);\n    const oneCycleData = allCycleDataState[0];\n    const i = bisect(oneCycleData, x0, 1);\n    const selectedData = oneCycleData[i];\n    const clientX = xScaleIn(selectedData.age);\n    var tooltipX = clientX; // prevent the tooltip from getting clipped.\n\n    const tooltipWidth = 75;\n\n    if (boundedWidth <= clientX + tooltipWidth) {\n      tooltipX = clientX - tooltipWidth;\n    }\n\n    getTooltipAgeSpan().text('age: ' + selectedData.age);\n    const ttBounds = getTooltipWrapper().node().getBBox();\n    getTooltipBackground().attr('width', ttBounds.width).attr('height', ttBounds.height);\n    getTooltipWrapper().attr(\"transform\", \"translate(\" + tooltipX + \",\" + coords[1] + \")\");\n    getHoverLine().attr('x', clientX);\n    getTooltipWrapper().attr('x', tooltipX);\n  };\n\n  const handleMouseLeave = () => {\n    getHoverLine().style('opacity', 0);\n    getTooltipWrapper().attr('display', 'none');\n  };\n  /*\n  const dumpCycleData = (oneCycle) => {\n      for (var i = 0; i < oneCycle.length; i++) {\n           console.log(oneCycle[i].year + \n              ' st:' + makeCurrency(oneCycle[i].beginValue) +\n              ' cpi:' + Number(oneCycle[i].cumulativeCPI).toFixed(2) + \n              ' sp:' + makeCurrency(oneCycle[i].actualSpend) + \n              ' e$:' + makeCurrency(oneCycle[i].equityAppr) +\n              ' d$:' + makeCurrency(oneCycle[i].divAppr) +\n              ' b$:' + makeCurrency(oneCycle[i].bondAppr) +\n              ' f$: ' + makeCurrency(oneCycle[i].fees) + \n              ' ae$: ' + makeCurrency(oneCycle[i].adjEndValue)\n              );\n      }\n  }\n   */\n\n\n  const calcBondYield = (bondStake, histIndex) => {\n    var retValue = 0; // if we're at the end of the cycle, use the simplified calculation\n\n    if (histData.length <= histIndex + 1) {\n      retValue = bondStake * histData[histIndex].bonds;\n    } else {\n      var bg1 = (1 - Math.pow(1 + histData[histIndex + 1].bonds, -9)) * histData[histIndex].bonds;\n      bg1 = bg1 / histData[histIndex + 1].bonds;\n      var bg2 = 1 / Math.pow(1 + histData[histIndex + 1].bonds, 9);\n      bg2 = bg2 - 1;\n      retValue = bondStake * (bg1 + bg2 + histData[histIndex].bonds);\n    }\n\n    return retValue;\n  };\n\n  const findHistStartIndex = startDataYear => {\n    const firstYear = histData[0].year;\n    const offset = startDataYear - firstYear;\n    return offset;\n  };\n\n  const calcAnnualAggReturn = (oneYear, stockPct, bondPct) => {\n    var retVal = oneYear.equityReturn * stockPct + oneYear.bondReturn * bondPct;\n\n    if (isNaN(retVal)) {\n      if (1 === stockPct) {\n        retVal = oneYear.equityReturn;\n      } else if (1 === bondPct) {\n        retVal = oneYear.bondReturn;\n      } else {\n        retVal = 0;\n        console.log('unexpected aggReturn result- equity :(' + makePct(oneYear.equityReturn) + ',' + makePct(stockPct) + ') ' + ' bond:(' + makePct(oneYear.bondReturn) + ',' + makePct(bondPct) + ')');\n      }\n    }\n\n    return retVal;\n  };\n\n  const runCycle = (startIndex, numYears) => {\n    var cycleData = [];\n    const stockPct = +props.stockallocation / 100;\n    const bondPct = +props.bondallocation / 100;\n    const feePct = +props.feepct / 100;\n    const ssAge = +props.ssage;\n    const ssIncome = +props.ssincome;\n    const startCPI = histData[startIndex].cpi;\n\n    for (var i = 0; i < numYears; i++) {\n      var obj = {\n        \"year\": histData[startIndex + i].year,\n        \"age\": +props.currentage + i,\n        \"beginValue\": i > 0 ? cycleData[i - 1].endValue : +props.portfoliovalue,\n        \"equityReturn\": histData[startIndex + i].equity,\n        \"equityAppr\": 0,\n        \"divAppr\": 0,\n        \"bondReturn\": 0,\n        \"bondAppr\": 0,\n        \"aggReturn\": 0,\n        \"cumulativeCPI\": histData[startIndex + i].cpi / startCPI,\n        \"spend\": +props.spendvalue,\n        \"actualSpend\": +props.spendvalue,\n        \"fees\": 0,\n        \"endValue\": 0,\n        \"adjEndValue\": 0,\n        \"appr\": 0,\n        \"adjAppr\": 0\n      }; // adjust spend for cumultative cpi\n\n      obj.actualSpend = obj.spend * obj.cumulativeCPI; // apply ss adjustment if applicable\n\n      var adjustment = ssAge <= obj.age ? ssIncome * obj.cumulativeCPI : 0;\n      obj.actualSpend -= adjustment; // port1 = subtract spend from start port\n\n      obj.endValue = obj.beginValue - obj.actualSpend;\n\n      if (0 < obj.endValue) {\n        var startStockValue = obj.endValue * stockPct; // e growth = port1 * e-share * e-growth\n\n        obj.equityAppr = startStockValue * obj.equityReturn; // calc dividends\n\n        obj.divAppr = startStockValue * histData[startIndex + i].dividends; // b growth = port1 * b=share * b-growth\n\n        obj.bondAppr = calcBondYield(obj.endValue * bondPct, startIndex + i);\n        obj.bondReturn = obj.bondAppr / (obj.beginValue * bondPct);\n        obj.aggReturn = calcAnnualAggReturn(obj, stockPct, bondPct); // port2 = port1 + e-growth + b-growth\n\n        obj.appr = obj.equityAppr + obj.divAppr + obj.bondAppr;\n        obj.endValue += obj.appr; // end port = port2 - (fees (based on cpi-adj value))\n\n        obj.fees = (obj.beginValue + obj.appr) * feePct;\n        obj.endValue -= obj.fees;\n        obj.adjEndValue = obj.endValue / obj.cumulativeCPI;\n        obj.adjAppr = obj.appr / obj.cumulativeCPI;\n        cycleData.push(obj);\n      } else {\n        obj.endValue = obj.adjEndValue = 0;\n        cycleData.push(obj);\n        break;\n      }\n    }\n\n    return cycleData;\n  };\n\n  const getBondReturns = allCycles => {\n    var retVal = [];\n\n    for (var iCycle = 0; iCycle < allCycles.length; iCycle++) {\n      for (var year = 0; year < allCycles[iCycle].length; year++) {\n        const oneYear = allCycles[iCycle][year];\n        retVal.push(oneYear.bondReturn);\n      }\n    }\n\n    return retVal;\n  };\n\n  const getAggReturns = allCycles => {\n    var retVal = [];\n\n    for (var iCycle = 0; iCycle < allCycles.length; iCycle++) {\n      for (var year = 0; year < allCycles[iCycle].length; year++) {\n        const oneYear = allCycles[iCycle][year];\n        retVal.push(oneYear.aggReturn);\n      }\n    }\n\n    return retVal;\n  };\n\n  const calcCycleMeta = (oneCycle, lifetime) => {\n    var extAdjEndValue = d3.extent(oneCycle, d => d.adjEndValue);\n    var avgAdjEndValue = d3.mean(oneCycle, d => d.adjEndValue);\n    var medAdjEndValue = d3.median(oneCycle, d => d.adjEndValue);\n    var totalSpend = d3.sum(oneCycle, d => d.actualSpend);\n    var totalAppr = d3.sum(oneCycle, d => d.appr);\n    var totalAdjAppr = d3.sum(oneCycle, d => d.adjAppr);\n    var pctStart = oneCycle[oneCycle.length - 1].adjEndValue / props.portfoliovalue;\n    const thisLineColor = getColorStringForRelativeValue(pctStart);\n    var extAggReturn = d3.extent(oneCycle, d => d.aggReturn);\n    var avgAggReturn = d3.mean(oneCycle, d => d.aggReturn);\n    var medAggReturn = d3.median(oneCycle, d => d.aggReturn);\n    var oneMeta = {\n      'startCycleValue': props.portfoliovalue,\n      'endCycleValue': oneCycle[oneCycle.length - 1].endValue,\n      'adjEndCycleValue': oneCycle[oneCycle.length - 1].adjEndValue,\n      'extent': extAdjEndValue,\n      'mean': avgAdjEndValue,\n      'median': medAdjEndValue,\n      'pctOfStart': pctStart,\n      'totalSpend': totalSpend,\n      'totalAppreciation': totalAppr,\n      'totalAdjAppreciation': totalAdjAppr,\n      'extAggReturn': extAggReturn,\n      'avgAggReturn': avgAggReturn,\n      'medAggReturn': medAggReturn,\n      'fail': 0 >= oneCycle[oneCycle.length - 1].adjEndValue,\n      'failAge': 0 >= oneCycle[oneCycle.length - 1].adjEndValue ? oneCycle.length + props.currentage : undefined,\n      'startYear': oneCycle[0].year,\n      'lineColor': thisLineColor\n    };\n    return oneMeta;\n  };\n\n  const calcSummaryData = allCycles => {\n    var extAdjEnd = d3.extent(allCycleMeta, d => d.adjEndCycleValue);\n    var avgAdjEnd = d3.mean(allCycleMeta, d => d.adjEndCycleValue);\n    var medAdjEnd = d3.median(allCycleMeta, d => d.adjEndCycleValue);\n    var avgSpend = d3.mean(allCycleMeta, d => d.totalSpend);\n    var medianSpend = d3.median(allCycleMeta, d => d.totalSpend);\n    var extSpend = d3.extent(allCycleMeta, d => d.totalSpend);\n    var aggReturns = getAggReturns(allCycles);\n    var avgReturns = d3.mean(aggReturns);\n    var medianReturns = d3.median(aggReturns);\n    var extReturns = d3.extent(aggReturns);\n    var avgAdjAppr = d3.mean(allCycleMeta, d => d.totalAdjAppreciation);\n    var medianAdjAppr = d3.median(allCycleMeta, d => d.totalAdjAppreciation);\n    var extAdjAppr = d3.extent(allCycleMeta, d => d.totalAdjAppreciation);\n    var numFails = 0;\n    var minFailAge = props.lifeexpectancy + 1;\n    var failAges = [];\n\n    for (var i = 0; i < allCycleMeta.length; i++) {\n      if (allCycleMeta[i].fail) {\n        minFailAge = Math.min(allCycleMeta[i].failAge, minFailAge);\n        failAges[numFails] = allCycleMeta[i].failAge;\n        numFails++;\n      }\n    }\n\n    setAvgAdjEndValueState(avgAdjEnd);\n    setMedianAdjEndValueState(medAdjEnd);\n    setMinAdjEndValueState(extAdjEnd[0]);\n    setMaxAdjEndValueState(extAdjEnd[1]);\n    setAvgSpendState(avgSpend);\n    setMedianSpendState(medianSpend);\n    setMinSpendState(extSpend[0]);\n    setMaxSpendState(extSpend[1]);\n    setAvgReturnsState(avgReturns);\n    setMedianReturnsState(medianReturns);\n    setMinReturnsState(extReturns[0]);\n    setMaxReturnsState(extReturns[1]);\n    setAvgAdjAppreciationState(avgAdjAppr);\n    setMedianAdjAppreciationState(medianAdjAppr);\n    setMinAdjAppreciationState(extAdjAppr[0]);\n    setMaxAdjAppreciationState(extAdjAppr[1]);\n    setNumCyclesState(allCycleMeta.length);\n    setNumFailsState(numFails);\n    setMinFailAgeState(minFailAge);\n    setMedianFailAgeState(d3.median(failAges));\n  };\n\n  const calcCycles = svg => {\n    const lifetime = props.lifeexpectancy - props.currentage + 1;\n    const startDataYear = props.startdatayear;\n    const endDataYear = props.enddatayear; // TODO : require numCycles to be greater than zero\n\n    const numCycles = endDataYear - startDataYear + 2 - lifetime;\n    const startIndex = findHistStartIndex(startDataYear);\n    var portMin = Number.POSITIVE_INFINITY;\n    var portMax = Number.NEGATIVE_INFINITY;\n    var allCycles = [];\n    cleanupPrev();\n\n    for (var i = 0; i < numCycles; i++) {\n      var oneCycle = runCycle(startIndex + i, lifetime);\n      var cycleMeta = calcCycleMeta(oneCycle, lifetime);\n      allCycleMeta[i] = cycleMeta;\n      allCycles[i] = oneCycle;\n      portMin = Math.min(portMin, cycleMeta.extent[0]);\n      portMax = Math.max(portMax, cycleMeta.extent[1]);\n    }\n\n    setAllCycleDataState(allCycles);\n    setAllCycleMetaState(allCycleMeta);\n    calcSummaryData(allCycles);\n    const xScale = getXScale();\n    const yScale = getYScale(portMin, portMax);\n    drawAxes(svg, xScale, yScale, portMin, portMax);\n\n    for (i = 0; i < numCycles; i++) {\n      drawPortfolioLine(svg, xScale, yScale, allCycleMeta[i], allCycles[i]);\n    }\n  };\n\n  React.useEffect(() => {\n    const svg = findByID(svgCycleChartID).append(\"g\").attr(\"transform\", marginTranslate);\n    calcCycles(svg);\n    prepHoverStuff(svg);\n  }, [props]);\n  return /*#__PURE__*/_jsxDEV(\"div\", {\n    children: [/*#__PURE__*/_jsxDEV(SummaryCards, {\n      fails: numFailsState,\n      cycles: numCyclesState,\n      minfailage: minFailAgeState,\n      medianfailage: medianFailAgeState,\n      medianendvalue: medianAdjEndValueState,\n      avgendvalue: avgAdjEndValueState,\n      minendvalue: minAdjEndValueState,\n      maxendvalue: maxAdjEndValueState,\n      medianreturns: medianReturnsState,\n      avgreturns: avgReturnsState,\n      minreturns: minReturnsState,\n      maxreturns: maxReturnsState\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 514,\n      columnNumber: 13\n    }, this), /*#__PURE__*/_jsxDEV(\"svg\", {\n      id: svgCycleChartID,\n      width: totalWidth,\n      height: totalHeight,\n      children: /*#__PURE__*/_jsxDEV(\"rect\", {\n        id: \"trackingRect\",\n        style: {\n          opacity: 0\n        },\n        width: boundedWidth,\n        height: boundedHeight,\n        transform: marginTranslate,\n        fill: \"LightGrey\",\n        onMouseDown: handleMouseDown,\n        onMouseEnter: handleMouseOver,\n        onMouseMove: handleMouseMove,\n        onMouseLeave: handleMouseLeave\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 526,\n        columnNumber: 17\n      }, this)\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 522,\n      columnNumber: 13\n    }, this), /*#__PURE__*/_jsxDEV(EndValueChart, {\n      startvalue: props.portfoliovalue,\n      minendvalue: minAdjEndValueState,\n      maxendvalue: maxAdjEndValueState,\n      medianendvalue: medianAdjEndValueState,\n      metadata: allCycleMetaState,\n      cyclechartid: svgCycleChartID\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 538,\n      columnNumber: 13\n    }, this)]\n  }, void 0, true, {\n    fileName: _jsxFileName,\n    lineNumber: 513,\n    columnNumber: 9\n  }, this);\n}\n\n_s(Chart, \"8NBpq0mB72Exuzg7g16Y8gKTunk=\");\n\n_c = Chart;\n;\nexport default Chart;\n\nvar _c;\n\n$RefreshReg$(_c, \"Chart\");","map":{"version":3,"sources":["/Users/paul/OneDrive/Documents/code/src/swrve/src/chart.js"],"names":["React","useState","d3","SummaryCards","EndValueChart","histData","getAvgEquityReturn","getStdDevEquityReturn","getAverageBondReturn","getStdBondReturn","makePct","getColorStringForRelativeValue","getPerRunClassName","getPortfolioLineClassName","cleanupPrev","findByID","Chart","props","allCycleDataState","setAllCycleDataState","allCycleMetaState","setAllCycleMetaState","avgAdjEndValueState","setAvgAdjEndValueState","medianAdjEndValueState","setMedianAdjEndValueState","minAdjEndValueState","setMinAdjEndValueState","maxAdjEndValueState","setMaxAdjEndValueState","avgSpendState","setAvgSpendState","medianSpendState","setMedianSpendState","minSpendState","setMinSpendState","maxSpendState","setMaxSpendState","avgReturnsState","setAvgReturnsState","medianReturnsState","setMedianReturnsState","minReturnsState","setMinReturnsState","maxReturnsState","setMaxReturnsState","avgAdjApprState","setAvgAdjAppreciationState","medianAdjApprState","setMedianAdjAppreciationState","minAdjApprState","setMinAdjAppreciationState","maxAdjApprState","setMaxAdjAppreciationState","numCyclesState","setNumCyclesState","numFailsState","setNumFailsState","minFailAgeState","setMinFailAgeState","medianFailAgeState","setMedianFailAgeState","svgCycleChartID","perRunClass","hoverLineID","ttWrapID","ttBackID","ttAgeID","margin","top","right","bottom","left","totalWidth","totalHeight","boundedWidth","boundedHeight","tooltipWidth","tooltipHeight","marginTranslate","normalStrokeWidth","allCycleMeta","getXScale","xExt","currentage","lifeexpectancy","scaleLinear","domain","range","getYScale","rangeMin","rangeMax","yExt","drawAxes","svg","xScaleIn","yScaleIn","append","attr","call","axisBottom","axisLeft","drawPortfolioLine","oneCycleMeta","oneCycle","classNames","lineColor","datum","startYear","style","line","x","d","age","y","adjEndValue","prepHoverStuff","tooltipWrapper","tooltipText","getHoverLine","getTooltipWrapper","getTooltipBackground","getTooltipAgeSpan","bondReturns","i","length","bondReturn","handleMouseDown","e","avgBondReturn","stdBondReturn","console","log","handleMouseOver","handleMouseMove","bisect","bisector","coords","pointer","x0","invert","oneCycleData","selectedData","clientX","tooltipX","text","ttBounds","node","getBBox","width","height","handleMouseLeave","calcBondYield","bondStake","histIndex","retValue","bonds","bg1","Math","pow","bg2","findHistStartIndex","startDataYear","firstYear","year","offset","calcAnnualAggReturn","oneYear","stockPct","bondPct","retVal","equityReturn","isNaN","runCycle","startIndex","numYears","cycleData","stockallocation","bondallocation","feePct","feepct","ssAge","ssage","ssIncome","ssincome","startCPI","cpi","obj","endValue","portfoliovalue","equity","spendvalue","actualSpend","spend","cumulativeCPI","adjustment","beginValue","startStockValue","equityAppr","divAppr","dividends","bondAppr","aggReturn","appr","fees","adjAppr","push","getBondReturns","allCycles","iCycle","getAggReturns","calcCycleMeta","lifetime","extAdjEndValue","extent","avgAdjEndValue","mean","medAdjEndValue","median","totalSpend","sum","totalAppr","totalAdjAppr","pctStart","thisLineColor","extAggReturn","avgAggReturn","medAggReturn","oneMeta","undefined","calcSummaryData","extAdjEnd","adjEndCycleValue","avgAdjEnd","medAdjEnd","avgSpend","medianSpend","extSpend","aggReturns","avgReturns","medianReturns","extReturns","avgAdjAppr","totalAdjAppreciation","medianAdjAppr","extAdjAppr","numFails","minFailAge","failAges","fail","min","failAge","calcCycles","startdatayear","endDataYear","enddatayear","numCycles","portMin","Number","POSITIVE_INFINITY","portMax","NEGATIVE_INFINITY","cycleMeta","max","xScale","yScale","useEffect","opacity"],"mappings":"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","sourcesContent":["import * as React from \"react\";\nimport {useState} from \"react\";\nimport * as d3 from \"d3\";\nimport SummaryCards from \"./summary.js\";\nimport EndValueChart from './endvaluechart.js';\nimport \"./chartdata.css\";\nimport { histData } from \"./histdata.js\";\nimport { getAvgEquityReturn, getStdDevEquityReturn, getAverageBondReturn, getStdBondReturn } from \"./histdata.js\";\nimport { makePct, getColorStringForRelativeValue, getPerRunClassName, getPortfolioLineClassName, cleanupPrev, findByID} from './common.js';\n\nfunction Chart (props) {\n  \n    const [allCycleDataState, setAllCycleDataState] = useState([]);\n    const [allCycleMetaState, setAllCycleMetaState] = useState([]);\n\n    const [avgAdjEndValueState, setAvgAdjEndValueState] = useState(0);\n    const [medianAdjEndValueState, setMedianAdjEndValueState] = useState(0);\n    const [minAdjEndValueState, setMinAdjEndValueState] = useState(0);\n    const [maxAdjEndValueState, setMaxAdjEndValueState] = useState(0);\n\n    const [avgSpendState, setAvgSpendState] = useState(0);\n    const [medianSpendState, setMedianSpendState] = useState(0);\n    const [minSpendState, setMinSpendState] = useState(0);\n    const [maxSpendState, setMaxSpendState] = useState(0);\n\n    const [avgReturnsState, setAvgReturnsState] = useState(0);\n    const [medianReturnsState, setMedianReturnsState] = useState(0);\n    const [minReturnsState, setMinReturnsState] = useState(0);\n    const [maxReturnsState, setMaxReturnsState] = useState(0);\n    \n    const [avgAdjApprState, setAvgAdjAppreciationState] = useState(0);\n    const [medianAdjApprState, setMedianAdjAppreciationState] = useState(0);\n    const [minAdjApprState, setMinAdjAppreciationState] = useState(0);\n    const [maxAdjApprState, setMaxAdjAppreciationState] = useState(0);\n    \n    const [numCyclesState, setNumCyclesState] = useState(0);\n    const [numFailsState, setNumFailsState] = useState(0);\n    const [minFailAgeState, setMinFailAgeState] = useState(0);\n    const [medianFailAgeState, setMedianFailAgeState] = useState(0);\n\n    const svgCycleChartID = 'd3cycletarget';\n    const perRunClass = getPerRunClassName();\n    const hoverLineID = 'hoverLine';\n    const ttWrapID = 'ttwrapper';\n    const ttBackID = 'ttbackground';\n    const ttAgeID = 'ttage';\n    const margin = { top: 40, right: 65, bottom: 40, left: 65 };\n    const totalWidth = 960;\n    const totalHeight = 500;\n    const boundedWidth = totalWidth - margin.left - margin.right;\n    const boundedHeight = totalHeight - margin.top - margin.bottom;\n    const tooltipWidth = 75;\n    const tooltipHeight = 75;\n    const marginTranslate = \"translate(\" + margin.left + \",\" + margin.top + \")\";\n    const normalStrokeWidth = 1.5;\n    var allCycleMeta = [];\n\n    const getXScale = () => { \n        var xExt = [props.currentage, props.lifeexpectancy];\n        return d3.scaleLinear()\n                    .domain(xExt)\n                    .range([ 0, boundedWidth ]);\n    }\n\n    const getYScale = (rangeMin, rangeMax) => {\n        var yExt = [rangeMin, rangeMax];\n        return d3.scaleLinear()\n                    .domain(yExt)\n                    .range([ boundedHeight, 0 ]);\n    }\n\n    const drawAxes = (svg, xScaleIn, yScaleIn, rangeMin, rangeMax) => {\n \n        svg.append(\"g\")\n            .attr(\"class\", perRunClass)\n            .attr(\"transform\", \"translate(0,\" + boundedHeight + \")\")\n            .call(d3.axisBottom(xScaleIn));\n        svg.append(\"g\")\n            .attr(\"class\", perRunClass)\n            .call(d3.axisLeft(yScaleIn));\n    };\n\n    const drawPortfolioLine = (svg, xScaleIn, yScaleIn, oneCycleMeta, oneCycle) => {\n\n        const classNames = perRunClass + ' ' \n                            + getPortfolioLineClassName() + ' ' \n                            + oneCycleMeta.lineColor;\n        svg.append(\"path\")\n            .datum(oneCycle)\n            .attr('id', oneCycleMeta.startYear)\n            .attr('class', classNames)\n            .attr(\"fill\", \"none\")\n            .attr(\"pointer-events\", \"none\")\n            .style(\"opacity\", 1)\n            .attr(\"stroke\", oneCycleMeta.lineColor)\n            .attr(\"stroke-width\", normalStrokeWidth)\n            .attr(\"d\", d3.line()\n                        .x(function(d) { return xScaleIn(d.age) })\n                        .y(function(d) { return yScaleIn(d.adjEndValue) })\n            );        \n    }\n\n    const prepHoverStuff = (svg) => {\n        const tooltipWrapper = svg\n                .append('g')\n                .attr('id', ttWrapID)\n                .attr('display', 'none');\n        \n        tooltipWrapper.append('rect')\n                        .style('opacity', 0.70)\n                        .attr('id', ttBackID)\n                        .attr('width', tooltipWidth)\n                        .attr('height', tooltipHeight)\n                        .attr(\"pointer-events\", \"none\")\n                        .attr(\"fill\", \"#e8e8e8\"); \n\n        const tooltipText = tooltipWrapper.append('g').append('text');\n\n        tooltipText.attr(\"pointer-events\", \"none\")\n                    .attr('font-weight', 900)\n                    .attr('text-anchor', 'left');\n                    \n        tooltipText.append('tspan')\n                    .attr('id', ttAgeID)\n                    .attr('x', '5')\n                    .attr('y', '5')\n                    .attr('dy', '15px')\n                    .attr(\"pointer-events\", \"none\");\n\n        svg.append(\"g\")\n           .append(\"rect\")\n            .style('opacity', 0)\n            .attr('id', hoverLineID)\n            .attr(\"pointer-events\", \"none\")\n            .attr(\"class\", \"dotted\")\n            .attr(\"stroke-width\", \"1px\")\n            .attr(\"width\", \".5px\")\n            .attr(\"height\", boundedHeight);\n        \n    }\n\n    const getHoverLine = () => {\n        return findByID(hoverLineID);\n    }\n\n    const getTooltipWrapper = () => {\n        return findByID(ttWrapID);\n    }\n\n    const getTooltipBackground = () => {\n        return findByID(ttBackID);\n    }\n\n    const getTooltipAgeSpan = () => {\n        return findByID(ttAgeID);\n    }\n\n    const getAverageBondReturn = () => {\n        var bondReturns = [];\n        for (var i = 0; i < allCycleDataState.length; i++) {\n            bondReturns[i] = allCycleDataState[i].bondReturn;\n        }\n    }\n\n    const handleMouseDown = (e) => {\n        var avgBondReturn = getAverageBondReturn();\n        var stdBondReturn = getStdBondReturn();\n        console.log('equity avg return:' + makePct(getAvgEquityReturn()) + ' equity sdev:' + makePct(getStdDevEquityReturn()));\n    }\n\n    const handleMouseOver = (e) => {\n        getHoverLine().style('opacity', 1);\n        getTooltipWrapper().attr('display', null);\n    }\n\n    const handleMouseMove = (e) => {\n        const bisect = d3.bisector((d) => d.age).left;\n        var xScaleIn = getXScale();\n        const coords = d3.pointer(e);\n        const x0 = xScaleIn.invert(coords[0]);\n        const oneCycleData = allCycleDataState[0];\n        const i = bisect(oneCycleData, x0, 1);\n        const selectedData = oneCycleData[i];\n        const clientX = xScaleIn(selectedData.age);\n        var tooltipX = clientX;\n        \n        // prevent the tooltip from getting clipped.\n        const tooltipWidth = 75;             \n        if (boundedWidth <= (clientX + tooltipWidth)) {\n            tooltipX = clientX - tooltipWidth;\n        }\n        getTooltipAgeSpan().text('age: ' + selectedData.age);\n\n        const ttBounds = getTooltipWrapper().node().getBBox();\n        getTooltipBackground()                \n            .attr('width', ttBounds.width)\n            .attr('height', ttBounds.height);\n\n        getTooltipWrapper().attr(\"transform\", \"translate(\" + tooltipX + \",\" + coords[1] + \")\");  \n\n        getHoverLine().attr('x', clientX);\n        getTooltipWrapper().attr('x', tooltipX);\n    };\n    \n    const handleMouseLeave = () => {\n        getHoverLine().style('opacity', 0);\n        getTooltipWrapper().attr('display', 'none');\n    };\n\n    /*\n    const dumpCycleData = (oneCycle) => {\n        for (var i = 0; i < oneCycle.length; i++) {\n\n            console.log(oneCycle[i].year + \n                ' st:' + makeCurrency(oneCycle[i].beginValue) +\n                ' cpi:' + Number(oneCycle[i].cumulativeCPI).toFixed(2) + \n                ' sp:' + makeCurrency(oneCycle[i].actualSpend) + \n                ' e$:' + makeCurrency(oneCycle[i].equityAppr) +\n                ' d$:' + makeCurrency(oneCycle[i].divAppr) +\n                ' b$:' + makeCurrency(oneCycle[i].bondAppr) +\n                ' f$: ' + makeCurrency(oneCycle[i].fees) + \n                ' ae$: ' + makeCurrency(oneCycle[i].adjEndValue)\n                );\n        }\n    }\n     */\n\n    const calcBondYield = (bondStake, histIndex) => {\n        \n        var retValue = 0;\n\n        // if we're at the end of the cycle, use the simplified calculation\n        if (histData.length <= (histIndex + 1)) {\n            retValue = bondStake * histData[histIndex].bonds;\n        }\n        else {\n            var bg1 = (1 - Math.pow(1 + histData[histIndex + 1].bonds, -9 ))\n                      * histData[histIndex].bonds;\n            bg1 = bg1 / histData[histIndex + 1].bonds;\n            \n            var bg2 = 1 / Math.pow(1 + histData[histIndex + 1].bonds, 9);\n            bg2 = bg2 - 1;\n\n            retValue = bondStake * (bg1 + bg2 + histData[histIndex].bonds);\n        }\n\n        return retValue;\n    }\n\n    const findHistStartIndex = (startDataYear) => {\n        const firstYear = histData[0].year;\n        const offset = startDataYear - firstYear;\n\n        return offset;\n    }\n\n    const calcAnnualAggReturn = (oneYear, stockPct, bondPct) => {\n\n        var retVal = (oneYear.equityReturn * stockPct) + (oneYear.bondReturn * bondPct);\n        \n        if (isNaN(retVal)) {\n            if (1 === stockPct) {\n                retVal = oneYear.equityReturn;\n            }\n            else if (1 === bondPct) {\n                retVal = oneYear.bondReturn;\n            }\n            else {\n                retVal = 0;\n                console.log('unexpected aggReturn result- equity :(' + \n                            makePct(oneYear.equityReturn) + ',' + makePct(stockPct) + ') ' +\n                            ' bond:(' +\n                            makePct(oneYear.bondReturn) + ',' + makePct(bondPct) + ')');\n            }\n        }\n\n        return retVal;\n    }\n    const runCycle = (startIndex, numYears) => {\n        var cycleData = [];\n        const stockPct = +(props.stockallocation) / 100;\n        const bondPct = +(props.bondallocation) / 100;\n        const feePct = +(props.feepct) / 100;\n        const ssAge = +(props.ssage);\n        const ssIncome = +(props.ssincome);\n        const startCPI = histData[startIndex].cpi;\n\n        for(var i = 0; i < numYears; i++){\n            var obj = { \"year\": histData[startIndex + i].year,\n                        \"age\": +(props.currentage) + i,\n                        \"beginValue\": (i > 0) ? cycleData[i - 1].endValue : +(props.portfoliovalue),\n                        \"equityReturn\": histData[startIndex + i].equity,\n                        \"equityAppr\": 0,\n                        \"divAppr\": 0,\n                        \"bondReturn\": 0,\n                        \"bondAppr\": 0,\n                        \"aggReturn\": 0,\n                        \"cumulativeCPI\": histData[startIndex + i].cpi / startCPI,\n                        \"spend\": +(props.spendvalue),\n                        \"actualSpend\": +(props.spendvalue),\n                        \"fees\": 0,\n                        \"endValue\": 0,\n                        \"adjEndValue\": 0,\n                        \"appr\": 0,\n                        \"adjAppr\": 0,\n                      };\n            // adjust spend for cumultative cpi\n            obj.actualSpend = obj.spend * obj.cumulativeCPI;\n            // apply ss adjustment if applicable\n            var adjustment = (ssAge <= obj.age) ? (ssIncome * obj.cumulativeCPI) : 0;\n            obj.actualSpend -= adjustment;\n            // port1 = subtract spend from start port\n            obj.endValue = obj.beginValue - obj.actualSpend;\n            if (0 < obj.endValue) {\n                var startStockValue = obj.endValue * stockPct;\n                // e growth = port1 * e-share * e-growth\n                obj.equityAppr = startStockValue * obj.equityReturn;\n                // calc dividends\n                obj.divAppr = startStockValue * histData[startIndex + i].dividends;\n                // b growth = port1 * b=share * b-growth\n                obj.bondAppr = calcBondYield(obj.endValue * bondPct, startIndex + i);\n                obj.bondReturn = obj.bondAppr / (obj.beginValue * bondPct);\n                obj.aggReturn = calcAnnualAggReturn(obj, stockPct, bondPct);\n                // port2 = port1 + e-growth + b-growth\n                obj.appr = obj.equityAppr + obj.divAppr + obj.bondAppr;\n                obj.endValue += obj.appr;\n                // end port = port2 - (fees (based on cpi-adj value))\n                obj.fees = (obj.beginValue + obj.appr) * feePct;\n                obj.endValue -= obj.fees;\n                obj.adjEndValue = obj.endValue / obj.cumulativeCPI;\n                obj.adjAppr = obj.appr / obj.cumulativeCPI;\n                cycleData.push(obj);\n            }\n            else {\n                obj.endValue = obj.adjEndValue = 0;\n                cycleData.push(obj);\n                break;\n            }\n        }\n        return cycleData;\n    }\n\n    const getBondReturns = (allCycles) => {\n        var retVal = [];\n\n        for (var iCycle = 0; iCycle < allCycles.length; iCycle++) {\n            for (var year = 0; year < allCycles[iCycle].length; year++) {\n                const oneYear = allCycles[iCycle][year];\n                retVal.push(oneYear.bondReturn);\n            }\n        }\n\n        return retVal;\n    }\n\n    const getAggReturns = (allCycles) => {\n        var retVal = [];\n\n        for (var iCycle = 0; iCycle < allCycles.length; iCycle++) {\n            for (var year = 0; year < allCycles[iCycle].length; year++) {\n                const oneYear = allCycles[iCycle][year];\n                retVal.push(oneYear.aggReturn);\n            }\n        }\n\n        return retVal;\n    }\n\n    const calcCycleMeta = (oneCycle, lifetime) => {\n        var extAdjEndValue = d3.extent(oneCycle, (d) => d.adjEndValue);\n        var avgAdjEndValue = d3.mean(oneCycle, (d) => d.adjEndValue);\n        var medAdjEndValue = d3.median(oneCycle, (d) => d.adjEndValue);\n        var totalSpend = d3.sum(oneCycle, (d) => d.actualSpend);\n        var totalAppr = d3.sum(oneCycle, (d) => d.appr);\n        var totalAdjAppr = d3.sum(oneCycle, (d) => d.adjAppr);\n        var pctStart = oneCycle[oneCycle.length - 1].adjEndValue / props.portfoliovalue;\n        const thisLineColor = getColorStringForRelativeValue(pctStart);\n        var extAggReturn = d3.extent(oneCycle, (d) => d.aggReturn);\n        var avgAggReturn = d3.mean(oneCycle, (d) => d.aggReturn);\n        var medAggReturn = d3.median(oneCycle, (d) => d.aggReturn);\n\n        var oneMeta = {\n            'startCycleValue': props.portfoliovalue,\n            'endCycleValue': oneCycle[oneCycle.length - 1].endValue,\n            'adjEndCycleValue': oneCycle[oneCycle.length - 1].adjEndValue,\n            'extent': extAdjEndValue,\n            'mean': avgAdjEndValue,\n            'median': medAdjEndValue,\n            'pctOfStart': pctStart,\n            'totalSpend': totalSpend,\n            'totalAppreciation': totalAppr,\n            'totalAdjAppreciation': totalAdjAppr,\n            'extAggReturn': extAggReturn,\n            'avgAggReturn': avgAggReturn,\n            'medAggReturn': medAggReturn,\n            'fail': (0 >= oneCycle[oneCycle.length - 1].adjEndValue),\n            'failAge': (0 >= oneCycle[oneCycle.length - 1].adjEndValue) ? \n                       (oneCycle.length + props.currentage) :\n                       undefined,\n            'startYear': oneCycle[0].year,\n            'lineColor': thisLineColor,\n        };\n\n        return oneMeta;\n    }\n\n    const calcSummaryData = (allCycles) => {\n\n        var extAdjEnd = d3.extent(allCycleMeta, (d) => d.adjEndCycleValue);\n        var avgAdjEnd = d3.mean(allCycleMeta, (d) => d.adjEndCycleValue);\n        var medAdjEnd = d3.median(allCycleMeta, (d) => d.adjEndCycleValue);\n\n        var avgSpend = d3.mean(allCycleMeta, (d) => d.totalSpend);        \n        var medianSpend = d3.median(allCycleMeta, (d) => d.totalSpend);\n        var extSpend = d3.extent(allCycleMeta, (d) => d.totalSpend);\n\n        var aggReturns = getAggReturns(allCycles);\n        var avgReturns = d3.mean(aggReturns);\n        var medianReturns = d3.median(aggReturns);\n        var extReturns = d3.extent(aggReturns);\n\n        var avgAdjAppr = d3.mean(allCycleMeta, (d) => d.totalAdjAppreciation);\n        var medianAdjAppr = d3.median(allCycleMeta, (d) => d.totalAdjAppreciation);\n        var extAdjAppr = d3.extent(allCycleMeta, (d) => d.totalAdjAppreciation);\n\n        var numFails = 0;\n        var minFailAge = props.lifeexpectancy + 1;\n        var failAges = [];\n\n        for (var i = 0; i < allCycleMeta.length; i++) {\n            if (allCycleMeta[i].fail) {\n                minFailAge = Math.min(allCycleMeta[i].failAge, minFailAge);\n                failAges[numFails] = allCycleMeta[i].failAge;\n                numFails++;\n            }\n        }\n\n        setAvgAdjEndValueState(avgAdjEnd);\n        setMedianAdjEndValueState(medAdjEnd);\n        setMinAdjEndValueState(extAdjEnd[0]);\n        setMaxAdjEndValueState(extAdjEnd[1]);\n\n        setAvgSpendState(avgSpend);\n        setMedianSpendState(medianSpend);\n        setMinSpendState(extSpend[0]);\n        setMaxSpendState(extSpend[1]);\n\n        setAvgReturnsState(avgReturns);\n        setMedianReturnsState(medianReturns);\n        setMinReturnsState(extReturns[0]);\n        setMaxReturnsState(extReturns[1]);\n\n        setAvgAdjAppreciationState(avgAdjAppr);\n        setMedianAdjAppreciationState(medianAdjAppr);\n        setMinAdjAppreciationState(extAdjAppr[0]);\n        setMaxAdjAppreciationState(extAdjAppr[1]);\n\n        setNumCyclesState(allCycleMeta.length);\n        setNumFailsState(numFails);\n        setMinFailAgeState(minFailAge);\n        setMedianFailAgeState(d3.median(failAges));\n    }\n\n    const calcCycles = (svg) => {\n        const lifetime = props.lifeexpectancy - props.currentage + 1;\n        const startDataYear = props.startdatayear;\n        const endDataYear = props.enddatayear;\n        // TODO : require numCycles to be greater than zero\n        const numCycles = (endDataYear - startDataYear + 2) - lifetime;\n        const startIndex = findHistStartIndex(startDataYear);\n        var portMin = Number.POSITIVE_INFINITY;\n        var portMax = Number.NEGATIVE_INFINITY;\n        var allCycles = [];\n\n        cleanupPrev();\n\n        for (var i = 0; i < numCycles; i++) {\n            var oneCycle = runCycle(startIndex + i, lifetime);\n            var cycleMeta = calcCycleMeta(oneCycle, lifetime);\n            \n            allCycleMeta[i] = cycleMeta;\n            allCycles[i] = oneCycle;\n\n            portMin = Math.min(portMin, cycleMeta.extent[0]);\n            portMax = Math.max(portMax, cycleMeta.extent[1]);\n        }\n\n        setAllCycleDataState(allCycles);\n        setAllCycleMetaState(allCycleMeta);\n\n        calcSummaryData(allCycles);\n\n        const xScale = getXScale();\n        const yScale = getYScale(portMin, portMax);\n\n        drawAxes(svg, xScale, yScale, portMin, portMax);\n        for (i = 0; i < numCycles; i++) {\n            drawPortfolioLine(svg, xScale, yScale, allCycleMeta[i], allCycles[i]);\n        }\n    }\n\n    React.useEffect(() => {\n\n        const svg = findByID(svgCycleChartID)\n                      .append(\"g\")\n                      .attr(\"transform\", marginTranslate);\n        calcCycles(svg);\n\n        prepHoverStuff(svg);\n    }, [props] );\n\n    return (\n        <div>\n            <SummaryCards \n             fails={numFailsState} cycles={numCyclesState}\n             minfailage={minFailAgeState} medianfailage={medianFailAgeState} \n             medianendvalue={medianAdjEndValueState} avgendvalue={avgAdjEndValueState}\n             minendvalue={minAdjEndValueState} maxendvalue={maxAdjEndValueState}\n             medianreturns={medianReturnsState} avgreturns={avgReturnsState}\n             minreturns={minReturnsState} maxreturns={maxReturnsState}\n             />\n            <svg id={svgCycleChartID} \n                    width={totalWidth}\n                    height={totalHeight} \n            >\n                <rect id='trackingRect'\n                    style={{ opacity:0 }}\n                    width={boundedWidth}\n                    height={boundedHeight}\n                    transform={marginTranslate}\n                    fill='LightGrey'\n                    onMouseDown={handleMouseDown}\n                    onMouseEnter={handleMouseOver}\n                    onMouseMove={handleMouseMove}\n                    onMouseLeave={handleMouseLeave}\n                />\n            </svg>  \n            <EndValueChart \n             startvalue={props.portfoliovalue} \n             minendvalue={minAdjEndValueState} \n             maxendvalue={maxAdjEndValueState} \n             medianendvalue={medianAdjEndValueState}\n             metadata={allCycleMetaState} \n             cyclechartid={svgCycleChartID} />            \n        </div>\n    );\n};\n\nexport default Chart;\n"]},"metadata":{},"sourceType":"module"}